include "root" {
  path = find_in_parent_folders()
}

terraform {
  source = "git::https://github.com/Puhhh/terraform-kubernetes-keycloak.git?ref=v1.0.3"
}

inputs = {
  deploy_method = "helm"
  # helm
  helm_custom_values      = true
  helm_custom_values_path = "keycloak.yaml"
  helm_chart_version      = "22.2.2"
  # values
  configmap_name  = "kubernetes-local"
  admin_username  = "admin"
  admin_password  = "admin"
  proxy_type      = "edge"
  production_mode = true
  # custom_certificates
  custom_certificates_secret      = true
  custom_certificates_secret_name = "kubernetes-local"
  custom_certificates             = "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUZXRENDQTBBQ0NRQzhWL0FuYy8xNTRUQU5CZ2txaGtpRzl3MEJBUXNGQURCdU1Rc3dDUVlEVlFRR0V3SlMKVlRFTU1Bb0dBMVVFQ0F3RFUxQmlNUXd3Q2dZRFZRUUhEQU5UVUdJeEV6QVJCZ05WQkFvTUNrdDFZbVZ5Ym1WMApaWE14RXpBUkJnTlZCQXNNQ2t0MVltVnlibVYwWlhNeEdUQVhCZ05WQkFNTUVFdDFZbVZ5Ym1WMFpYTlNiMjkwClEwRXdIaGNOTWpRd09ESXdNVFkwTXpNMFdoY05NelF3T0RFNE1UWTBNek0wV2pCdU1Rc3dDUVlEVlFRR0V3SlMKVlRFTU1Bb0dBMVVFQ0F3RFUxQmlNUXd3Q2dZRFZRUUhEQU5UVUdJeEV6QVJCZ05WQkFvTUNrdDFZbVZ5Ym1WMApaWE14RXpBUkJnTlZCQXNNQ2t0MVltVnlibVYwWlhNeEdUQVhCZ05WQkFNTUVFdDFZbVZ5Ym1WMFpYTlNiMjkwClEwRXdnZ0lpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElDRHdBd2dnSUtBb0lDQVFEV3o3Z1B4cXAxaUQzOE45TW8KNHhuNmEvTE44TzFWWHQxVXBPM2Z0OVV2cnpDbC9xNkRja2s2NFRNeG9UTVhVb3E1dHgrZnl6RG5UYjlRdXF2WgpYeGxHVE50dEo4Mjg0Q0FQc0JVTkRSWStsdmNrQWZFL0NrV01JWktiSTllTTZYTTFEWDFpNVU2SlVOMW96N3B1Ci9ZWEdISndIU3labGpOZzEwOHdzdUNoc3FxMG5LRE0zaS9ObVhQc25mWmduTmZhNmpTekllN2ZkdFJjYmhOQnEKZUZqN2ZQeDN2bjlqbHF5UzlLTTB6LzV5NkVxT3EzRVcrN211c01sL0ExcFpuemkxK3BCRXNrYnZsdmtKMUliLwpSSE1uakRyaCtWQThyY21GM0tOT3pERDlGd0FPNU91L0JyTm1KZis0K3hPQXlFWmdyZ1JvMW8xUVEwZVF6cCtEClRYU2pWKzZINmtKSUttcC9YOHJxYUtsZk1Icjg3Qy9oaEFFZ0N2MkJ1azFNSzErV1hmMkwvdFhrblFOdElNMGUKalJoall0aXJhYzRmcFlyS1U0aEt4ajByaytpa2t1aDd0bkFkTThaeUhad0NZUEFlQ1dzTWx5b1hKU3dMM2xjVwpKVzZ4bGYzNnd0YXlRRjNaLyt1SmxwNU5paG5VSGJTRzA2ejhidDZwaDRBbVBwU2VrQjNkRUd2UHJjWjNwVVBRCjZZUVpkWHpGVzRCVUZ2dU5SQStLVXVRRGRLOXBjczFxSzRkVUJnNmJkUHhuemhHbGtQazRVL2treE1Zd29mc0wKQnFQNmxLcmFJRHdIbDBiWi84NG54bWdxSjlpenpIRzA5QnpyT2dLMDlFNUF5NUljK2hsdWlRbjg0OWluaU1oYwpIM0JLZ2FDZkFUZWNRdXM0cVJ2ZDJNdlk5UUlEQVFBQk1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQ0FRQ2YySG9qCmNia2MvcUc4TFZJWndGTTNiOTd3UVNqNW1mR1pOSGRwbHhOMzVYMVBYYktoTUtYY3B5bVU3TU5EaW0wcVNhQ20KbGo3R1paTHZxcjY4SERJbFZYZFlSZDBKQXlTWUwyR1JJZlFnNmMrcGhOSnR5TU9mdVREdlZiaTFCSUNUWmM4QQo3dlJaK0VMODdhdHpHeGJ5YzkrcFdlN3hJV1UyWFF3TktlV3NSSFBIOXdaZnRVRW1sNDN5UDhXb3lsY1QwT1VuClBCTG1scUVYL2IxbXpvbEp5djFwN2xxckNNN09xNk40WkN1c1dIc3UwMmhUTmhEMm0yaVA0Y0FRQTBsU2VFbGoKL3E4Um9jQmhkWDkzRXkwR3lqUzB4WnV5d0syTkJHcHM3ZDB6eFVmeHFoZ2RQZzBvTCs1MEc0VGJadld5Ty9CagpZWEtYYXg5THJvTWZoYkI0WktkbDhRcWRyWEdYMjZrZ1NJMUkyRWU4dmYvWG9xenpLV3A3R0dMTGwyd3BZUVFZCkljN1BzTEFTUFFJN3kxOEdGaysraVdnaE9NWGMybThna1BzNmdEQkdEZ3REMDZxT3Bpc0ltZFV5RzRoZUI5WHkKcTZnTUZrOHRaK0FEdUZXN2RzeStnNmgxQjk5ditNSk5KbEdicE00b21WejZhYTY5Mm93WjF2ajRTZ3FMSEJ0Sgpxa29UengzcDBzelVFdmNsb1YxbTBIbEJKSFBRaGw0UHVYVDdSeUZMSS9CaWF3c1RlOVFwNW5PMmx3SU5hRlBUCnVHeFZPbGhVZnU4VjZHV2szNGxZVUdXc21sb3pNaVMwVVRqaHBvOVJzZHJQRzRJUlVCc3F4ZzUwNFAzSFBSMVoKRUthQm5EZ2RqdTloMXFwTDltRkpiVlpIRkFSY2FFOTQzamR4eHc9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCi0tLS0tQkVHSU4gQ0VSVElGSUNBVEUtLS0tLQpNSUlGWURDQ0EwZ0NDUUNIWUpHeFowbU9uekFOQmdrcWhraUc5dzBCQVFzRkFEQnVNUXN3Q1FZRFZRUUdFd0pTClZURU1NQW9HQTFVRUNBd0RVMUJpTVF3d0NnWURWUVFIREFOVFVHSXhFekFSQmdOVkJBb01Da3QxWW1WeWJtVjAKWlhNeEV6QVJCZ05WQkFzTUNrdDFZbVZ5Ym1WMFpYTXhHVEFYQmdOVkJBTU1FRXQxWW1WeWJtVjBaWE5TYjI5MApRMEV3SGhjTk1qUXdPREl3TVRZME5EUXdXaGNOTXpRd09ERTRNVFkwTkRRd1dqQjJNUXN3Q1FZRFZRUUdFd0pTClZURU1NQW9HQTFVRUNBd0RVMUJpTVF3d0NnWURWUVFIREFOVFVHSXhFekFSQmdOVkJBb01Da3QxWW1WeWJtVjAKWlhNeEV6QVJCZ05WQkFzTUNrdDFZbVZ5Ym1WMFpYTXhJVEFmQmdOVkJBTU1HRXQxWW1WeWJtVjBaWE5KYm5SbApjbTFsWkdsaGRHVkRRVENDQWlJd0RRWUpLb1pJaHZjTkFRRUJCUUFEZ2dJUEFEQ0NBZ29DZ2dJQkFNcjl6ZmttCnE1MzJNaEF0OXNyWHgzaTBsQklidm5EZ0VRYk52RGxVZHFLR0FBdEZCT2YxeGZZSEpyMXh2VUlHNC9FT3kwRW8KSXBWSFJNZEJNejVtQWNmck5TOWdGcXI5c0k5aWtzeDQ0MXlaQ3NHejNHa2xQUk5HemRBY2xvSUxSdHBMVS9kaApzMG1TQkp5T3ZXT2JnaVJaSTh6TFVPa2dON09RQVY1eVdlQnNKdDJTMVdvRmhEaWF2bVd5d2VvMXBCb3BIeEtvCkhoT1o0ZEd5STdFSHhzSVN2eGlTTG1vWjl1OXYwTnh6MXYySjFaNHZaUDFyVEgyeWEwaW4vMVB3SnFPWUdEbWMKY1pVcnY4UUNvT3B2S1hNVDczeDBzcHhPUkhRNis3TTdVWWt3WVJyQXBPQUo5eHZVWXBHWXBad2JEYngvRGE3bgptc2JUclVtU2xXekN6WEF3RjdaelJ0cG1lV0xNU0YyN0lVL2tHaVZSYWhFcUZNdkYyOWtFZWdSNDZSalZxVnFXCjZVdUhZMko3ck5BMHMrYkV0NkF3UzRidG1CK2g4cWlDbENGUTgzdUdSY2ExM2J4MFIwY1RVWjU5czVmMkM0SVEKUHVIZjQ4N1p1Q2d1L0V0ZjNVenlEdUhvWlJ6S0I1WlRrV2JKREVqckRJd3Y3ZlFEV1RBYkNseXg1dEVlWkdHSQo5NWJkeHAyM0VVSGNGcStRblB1cmRDaTJjckpTZGtwUWs1Q0xUaFhrVU90ekhMT3laQ2NtMm1SckxWU2NFbVdKCnVVajJZbm5nME9FaVpQMTlaTXVYQVEzbkZRR1kwVTJtVStSZG1OU3dyQUJKMWlrdW9MM0l6dXVWdUlCZWlKT3MKL2lkSXBVQlRmbGY1S3ZTdDgrS0JsZGNqVm1vcW9NemNxeHkvQWdNQkFBRXdEUVlKS29aSWh2Y05BUUVMQlFBRApnZ0lCQUsyaVNnTTRxc05kYjNFbndUWGFOcUpINWZUTXpWWUJRcWFEeFU4OEdyZUFMZWlXd25HbTVkRzlXWTFsClJBT2UrdXQrSmRqOS90RlQ5cHYwQkoxTkFNWW1Oa0pMdW41dUhoaHNSZ3hDVmd3UFdjMENsbmZmTVhydTIwRlkKMWVyY2p4ZmpMMlZyekx0V000NmVSUDRlemRMS1NJUlJEdGJtdGxHbVd1dHh1eS9DMUtFbTF1VFRla3p5blJrdApIQkg1VjIxSDZlQ3dVS3h1NElreUNHN0ZCakJWaVFRcVBJTk1TUGlKMXpwdmFVem04dEY5cjM5bUhPc2QyWnVoCjRMbTFRTms4Yi9xMkt5aWtpenZmS2lVOFI1U0I1Wmo2QVVVVWRsMitmQy9BZm1rWEJoSFpkUHp1WUM1K1JFYjgKOGdMai85TUNXYW1YdlMrM2xTS1NmeHFFWXRjaVRnSTc2em9JRzVWWkU3OUtGUDRYZk9oMEMrTllEWDhQSWhHUgp3SUVsVnBWbVQ1UzY5MFVkWkp4V1dXMmlQZUQ1bzFhdEJQeDJjaG5EK1JjV2VLZXV4ZlpFekxuakNUMUk3Wmh4CmNnbFBzd1kwL1dMSzIzSVNQQ3BQTWROb2tpUjZZRmxsc1NWQkMxdURNZ0h4RlBLaHdpayttSVBlTVptcWhCRzQKeStqUitNWTZHRHRFMGJsb3RGZ1I0R1BuM2k2R3ZMQ0FidHFyOGU3RTFMTEx0YXI0ZzZ3WUJ2Q2ZrVDNOWkZ0awpqR0dvVG8vbU5SbnNMY1JLdUgwL3ArMmtOdWhjK0paMnVDSlJLcWJFTWVPS0lhdHFhV2ZVUjU1ZGlJZUdZRkxGCnRmMVFpT2J0bXZyMWp4SUY2cEhQZDNJWnV6ZkFNbW1uZEtYSDMrV3JEdWhZWWVmKwotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0t"
  # database
  default_postgresql        = false
  use_db_credentials_secret = true
  db_credentials_secret = {
    secret_name  = "keycloak-pg-secret"
    host_key     = "db-host"
    port_key     = "db-port"
    dbname_key   = "db-name"
    username_key = "username"
    password_key = "password"
  }
  cloudnativepg_database          = true
  cloudnativepg_storage_size      = "3Gi"
  cloudnativepg_database_password = "SuperPWD"
}

generate "module" {
  path      = "network.tf"
  if_exists = "overwrite"
  contents  = <<EOF

module "istio_network" {
  source = "github.com/Puhhh/terraform-istio-network"

  tls-name                       = "keycloak"
  server-url                     = "keycloak.kubernetes.local"
  tls-certificate-files          = true
  tls-crt                        = "LS0tL...tCg=="
  tls-key                        = "LS0tL...tLS0K"
  server-svc-name                = "keycloak"
  server-svc-namemespace         = "keycloak"
  destination-port               = 80
}
EOF
}